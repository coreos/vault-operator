# Vault metrics in Prometheus format

[Vault metrics](https://www.vaultproject.io/docs/internals/telemetry.html) by default
doesn't support Prometheus format.
It can be exported via [statsd](https://www.vaultproject.io/docs/configuration/telemetry.html)
and then converted to Prometheus format via [statsd-exporter][statsd_exporter_repo].

Prerequisites:

- Vault and etcd operator deployed

## Getting started

### Deploy statsd-exporter

Create [statsd-exporter][statsd_exporter_repo] deployment and service:

```
kubectl create -f example/prom_metrics/statsd_exporter.yaml
```

### Deploy Vautl cluster with metrics config

Create configmap with `vault.hcl` that contains metrics config:

```
kubectl create configmap vault-metrics-config --from-file=example/prom_metrics/vault.hcl
```

Create Vault cluster:

```
kubectl create -f example/prom_metrics/vault_with_metrics.yaml
```

### Check Prometheus metrics

Exec into one of the Vault pods to curl `/metrics` via `statsd-exporter` service:
```
$ VPOD=$(kubectl get vault example-vault -o jsonpath='{.status.nodes.available[0]}')
$ kubectl exec -ti ${VPOD} -- curl statsd-exporter:9102/metrics
...
# HELP vault_runtime_gc_pause_ns Metric autogenerated by statsd_exporter.
# TYPE vault_runtime_gc_pause_ns summary
vault_runtime_gc_pause_ns{quantile="0.5"} 68506
vault_runtime_gc_pause_ns{quantile="0.9"} 5.807206e+06
vault_runtime_gc_pause_ns{quantile="0.99"} 7.483349e+06
vault_runtime_gc_pause_ns_sum 1.7125135e+07
vault_runtime_gc_pause_ns_count 18
```



[statsd_exporter_repo]:https://github.com/prometheus/statsd_exporter
